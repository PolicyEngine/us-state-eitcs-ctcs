<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Tax Credits Impact | PolicyEngine</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1a1a;
            --ink-light: #2d2d2d;
            --ink-muted: #6b6b6b;
            --paper: #faf9f7;
            --paper-warm: #f5f3ef;
            --accent: #2563eb;
            --accent-deep: #1e40af;
            --accent-glow: rgba(37, 99, 235, 0.08);
            --emerald: #059669;
            --emerald-light: #d1fae5;
            --coral: #dc2626;
            --gold: #d97706;
            --divider: #e5e2dc;
            --divider-dark: #c9c5bc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', Georgia, serif;
            background: var(--paper);
            color: var(--ink);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Editorial Header */
        .masthead {
            background: var(--ink);
            padding: 12px 0;
            border-bottom: 3px solid var(--accent);
        }

        .masthead-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .masthead-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .masthead-logo img {
            height: 32px;
            filter: brightness(0) invert(1);
        }

        .masthead-tagline {
            color: rgba(255,255,255,0.5);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(180deg, var(--ink) 0%, var(--ink-light) 100%);
            color: white;
            padding: 80px 32px 100px;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        .hero-inner {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            text-align: center;
        }

        .hero-label {
            display: inline-block;
            background: var(--accent);
            color: white;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 6px 16px;
            margin-bottom: 24px;
            border-radius: 2px;
        }

        .hero h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(36px, 6vw, 64px);
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 24px;
            letter-spacing: -1px;
        }

        .hero-subtitle {
            font-size: 20px;
            font-weight: 300;
            color: rgba(255,255,255,0.7);
            max-width: 650px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Stats Banner */
        .stats-banner {
            max-width: 1200px;
            margin: -50px auto 0;
            padding: 0 32px;
            position: relative;
            z-index: 10;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .stat-item {
            padding: 32px 28px;
            text-align: center;
            border-right: 1px solid var(--divider);
            position: relative;
            transition: background 0.2s ease;
        }

        .stat-item:last-child {
            border-right: none;
        }

        .stat-item:hover {
            background: var(--accent-glow);
        }

        .stat-eyebrow {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--ink-muted);
            margin-bottom: 8px;
        }

        .stat-number {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--ink);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-context {
            font-size: 13px;
            color: var(--ink-muted);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 48px 32px;
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 24px;
            padding: 20px 0;
            border-bottom: 2px solid var(--ink);
            margin-bottom: 32px;
        }

        .control-section {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-muted);
        }

        .pill-group {
            display: flex;
            background: var(--paper-warm);
            border-radius: 100px;
            padding: 4px;
            gap: 2px;
        }

        .pill-btn {
            padding: 8px 18px;
            border: none;
            background: transparent;
            color: var(--ink-muted);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 100px;
            transition: all 0.2s ease;
        }

        .pill-btn:hover {
            color: var(--ink);
        }

        .pill-btn.active {
            background: var(--ink);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .metric-dropdown {
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b6b6b' d='M6 8L2 4h8z'/%3E%3C/svg%3E") no-repeat right 14px center;
            border: 2px solid var(--divider);
            border-radius: 4px;
            padding: 10px 40px 10px 16px;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--ink);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .metric-dropdown:hover {
            border-color: var(--divider-dark);
        }

        .metric-dropdown:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Map Section */
        .visualization {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 32px;
        }

        @media (max-width: 1100px) {
            .visualization {
                grid-template-columns: 1fr;
            }
        }

        .map-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            position: relative;
        }

        .map-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .map-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--ink);
        }

        .map-hint {
            font-size: 12px;
            color: var(--ink-muted);
        }

        #map-container {
            width: 100%;
            height: 580px;
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 4px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            min-width: 140px;
            z-index: 10;
        }

        .legend-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ink-muted);
            margin-bottom: 12px;
        }

        .legend-scale {
            display: flex;
            gap: 8px;
        }

        .legend-gradient {
            width: 16px;
            height: 100px;
            border-radius: 2px;
            background: linear-gradient(to bottom,
                #1e3a5f, #2563eb, #3b82f6, #60a5fa, #93c5fd, #dbeafe);
        }

        .legend-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
            color: var(--ink-muted);
        }

        .legend-zero {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px solid var(--divider);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-zero-swatch {
            width: 16px;
            height: 12px;
            background: #d1d5db;
            border-radius: 2px;
        }

        .legend-zero-text {
            font-size: 11px;
            color: var(--ink-muted);
        }

        /* Detail Panel */
        .detail-panel {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            position: sticky;
            top: 24px;
        }

        .detail-header {
            background: var(--ink);
            color: white;
            padding: 24px;
        }

        .detail-region {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }

        .detail-empty {
            padding: 60px 24px;
            text-align: center;
        }

        .detail-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .detail-empty p {
            color: var(--ink-muted);
            font-size: 15px;
            line-height: 1.6;
        }

        .detail-metrics {
            padding: 8px 0;
        }

        .detail-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--divider);
            transition: background 0.15s ease;
        }

        .detail-metric:last-child {
            border-bottom: none;
        }

        .detail-metric:hover {
            background: var(--paper-warm);
        }

        .detail-metric-label {
            font-size: 14px;
            color: var(--ink-muted);
            font-weight: 500;
        }

        .detail-metric-value {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--ink);
        }

        .detail-metric-value.positive {
            color: var(--emerald);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 120px 40px;
            color: var(--ink-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--divider);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            background: var(--ink);
            color: rgba(255,255,255,0.5);
            padding: 40px 32px;
            margin-top: 80px;
            text-align: center;
            font-size: 13px;
        }

        .footer a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }

        .footer a:hover {
            color: white;
            border-bottom-color: white;
        }

        /* Popup Styling */
        .maplibregl-popup-content {
            padding: 16px 20px;
            border-radius: 4px;
            font-family: 'Source Sans 3', sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: none;
        }

        .maplibregl-popup-tip {
            border-top-color: white !important;
        }

        .popup-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 600;
            font-size: 16px;
            color: var(--ink);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .popup-value {
            font-size: 14px;
            color: var(--ink-muted);
            line-height: 1.5;
        }

        .popup-value strong {
            color: var(--ink);
            font-weight: 600;
        }

        .popup-hint {
            font-size: 11px;
            color: var(--accent);
            margin-top: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-item {
                border-right: none;
                border-bottom: 1px solid var(--divider);
            }

            .stat-item:last-child {
                border-bottom: none;
            }

            .control-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .control-section {
                flex-wrap: wrap;
            }

            .hero {
                padding: 60px 24px 80px;
            }

            .hero h1 {
                font-size: 32px;
            }
        }

        /* Animation on load */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .control-bar {
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .visualization {
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }
    </style>
</head>
<body>
    <header class="masthead">
        <div class="masthead-inner">
            <a href="https://policyengine.org" class="masthead-logo">
                <img src="policyengine-logo.svg" alt="PolicyEngine" />
            </a>
            <span class="masthead-tagline">Data & Analysis</span>
        </div>
    </header>

    <section class="hero">
        <div class="hero-inner">
            <span class="hero-label">Interactive Analysis</span>
            <h1>The Impact of State Tax Credits on American Families</h1>
            <p class="hero-subtitle">
                Explore how state-level Earned Income Tax Credits and Child Tax Credits
                reduce poverty across communities. Data powered by PolicyEngine microsimulation.
            </p>
        </div>
    </section>

    <div id="root">
        <div class="stats-banner">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="loading-spinner"></div>
                    <div class="stat-context">Loading data...</div>
                </div>
                <div class="stat-item">
                    <div class="loading-spinner"></div>
                    <div class="stat-context">Loading data...</div>
                </div>
                <div class="stat-item">
                    <div class="loading-spinner"></div>
                    <div class="stat-context">Loading data...</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Data calculated using PolicyEngine microsimulation model for 2025 &nbsp;|&nbsp;
        <a href="https://policyengine.org" target="_blank">policyengine.org</a>
    </footer>

    <script>
        // State codes and names
        const STATE_CODES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
            'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
            'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
            'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
            'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
            'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
            'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
            'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
            'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
            'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        const STATE_FIPS_NAMES = {
            1: 'Alabama', 2: 'Alaska', 4: 'Arizona', 5: 'Arkansas', 6: 'California',
            8: 'Colorado', 9: 'Connecticut', 10: 'Delaware', 11: 'District of Columbia',
            12: 'Florida', 13: 'Georgia', 15: 'Hawaii', 16: 'Idaho', 17: 'Illinois',
            18: 'Indiana', 19: 'Iowa', 20: 'Kansas', 21: 'Kentucky', 22: 'Louisiana',
            23: 'Maine', 24: 'Maryland', 25: 'Massachusetts', 26: 'Michigan', 27: 'Minnesota',
            28: 'Mississippi', 29: 'Missouri', 30: 'Montana', 31: 'Nebraska', 32: 'Nevada',
            33: 'New Hampshire', 34: 'New Jersey', 35: 'New Mexico', 36: 'New York',
            37: 'North Carolina', 38: 'North Dakota', 39: 'Ohio', 40: 'Oklahoma',
            41: 'Oregon', 42: 'Pennsylvania', 44: 'Rhode Island', 45: 'South Carolina',
            46: 'South Dakota', 47: 'Tennessee', 48: 'Texas', 49: 'Utah', 50: 'Vermont',
            51: 'Virginia', 53: 'Washington', 54: 'West Virginia', 55: 'Wisconsin', 56: 'Wyoming'
        };

        const STATE_FIPS_TO_CODE = {
            1: 'AL', 2: 'AK', 4: 'AZ', 5: 'AR', 6: 'CA', 8: 'CO', 9: 'CT', 10: 'DE',
            11: 'DC', 12: 'FL', 13: 'GA', 15: 'HI', 16: 'ID', 17: 'IL', 18: 'IN', 19: 'IA',
            20: 'KS', 21: 'KY', 22: 'LA', 23: 'ME', 24: 'MD', 25: 'MA', 26: 'MI', 27: 'MN',
            28: 'MS', 29: 'MO', 30: 'MT', 31: 'NE', 32: 'NV', 33: 'NH', 34: 'NJ', 35: 'NM',
            36: 'NY', 37: 'NC', 38: 'ND', 39: 'OH', 40: 'OK', 41: 'OR', 42: 'PA', 44: 'RI',
            45: 'SC', 46: 'SD', 47: 'TN', 48: 'TX', 49: 'UT', 50: 'VT', 51: 'VA', 53: 'WA',
            54: 'WV', 55: 'WI', 56: 'WY'
        };

        const STATE_NAME_TO_CODE = {};
        Object.entries(STATE_CODES).forEach(([code, name]) => {
            STATE_NAME_TO_CODE[name] = code;
        });

        const METRICS = {
            'cost': { label: 'Total Cost', format: 'currency', colorscaleReverse: false },
            'poverty_pct_cut': { label: 'Poverty Reduction', format: 'percent', colorscaleReverse: false },
            'child_poverty_pct_cut': { label: 'Child Poverty Reduction', format: 'percent', colorscaleReverse: false }
        };

        // Editorial blue color scale
        const ZERO_COLOR = '#d1d5db';
        const NO_DATA_COLOR = '#e5e7eb';
        const COLOR_SCALE = [
            '#dbeafe',  // lightest blue
            '#93c5fd',
            '#60a5fa',
            '#3b82f6',
            '#2563eb',
            '#1e3a5f'   // darkest navy
        ];

        let appState = {
            viewType: 'state',
            creditType: 'CTCs and EITCs',
            metric: 'cost',
            stateData: null,
            districtData: null,
            stateGeoData: null,
            districtGeoData: null,
            selectedRegion: null,
            map: null,
            popup: null
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, idx) => {
                    const val = values[idx];
                    row[header] = isNaN(val) ? val : parseFloat(val);
                });
                data.push(row);
            }
            return data;
        }

        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            if (format === 'currency') {
                const absValue = Math.abs(value);
                if (absValue >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
                if (absValue >= 1e6) return '$' + (value / 1e6).toFixed(1) + 'M';
                if (absValue >= 1e3) return '$' + (value / 1e3).toFixed(1) + 'K';
                return '$' + value.toFixed(0);
            } else if (format === 'percent') {
                return (value * 100).toFixed(2) + '%';
            }
            return value.toFixed(2);
        }

        function filterData(data, creditType) {
            return data.filter(row => row.reform_type === creditType);
        }

        function calculateStats(data, metric) {
            const values = data.map(d => d[metric]).filter(v => !isNaN(v) && v !== null);
            const total = values.reduce((a, b) => a + b, 0);
            const avg = total / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            return { total, avg, max, min, count: values.length };
        }

        function getRegionData(regionId) {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);
            if (appState.viewType === 'state') {
                return filteredData.find(d => d.state === regionId);
            } else {
                return filteredData.find(d => d.congressional_district_geoid === regionId);
            }
        }

        function renderDetailPanel() {
            const region = appState.selectedRegion;
            if (!region) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <div class="detail-empty-icon">üìç</div>
                            <p>Select a ${appState.viewType === 'state' ? 'state' : 'district'} on the map to explore detailed impact metrics</p>
                        </div>
                    </div>
                `;
            }
            const data = getRegionData(region.id);
            if (!data) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <p>No data available for this region</p>
                        </div>
                    </div>
                `;
            }
            const metrics = [
                { key: 'cost', label: 'Total Cost', format: 'currency' },
                { key: 'poverty_pct_cut', label: 'Poverty Reduction', format: 'percent' },
                { key: 'child_poverty_pct_cut', label: 'Child Poverty Reduction', format: 'percent' }
            ];
            return `
                <div class="detail-panel">
                    <div class="detail-header">
                        <div class="detail-region">${region.name}</div>
                        <div class="detail-subtitle">${appState.creditType} Impact Analysis</div>
                    </div>
                    <div class="detail-metrics">
                        ${metrics.map(m => {
                            const value = data[m.key];
                            const formattedValue = formatValue(value, m.format);
                            const valueClass = m.format === 'percent' && value > 0 ? 'positive' : '';
                            return `
                                <div class="detail-metric">
                                    <span class="detail-metric-label">${m.label}</span>
                                    <span class="detail-metric-value ${valueClass}">${formattedValue}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function updateLegend(min, max, metricInfo) {
            const maxEl = document.getElementById('legend-max');
            const minEl = document.getElementById('legend-min');
            const titleEl = document.getElementById('legend-title');
            if (maxEl) maxEl.textContent = formatValue(max, metricInfo.format);
            if (minEl) minEl.textContent = formatValue(min, metricInfo.format);
            if (titleEl) titleEl.textContent = metricInfo.label;
        }

        function enrichGeoDataWithValues(geoData, dataMap, idField, metricKey) {
            return {
                type: 'FeatureCollection',
                features: geoData.features.map(feature => {
                    let id;
                    if (appState.viewType === 'state') {
                        const stateName = feature.properties.name;
                        id = STATE_NAME_TO_CODE[stateName];
                    } else {
                        if (feature.properties.GEOID) {
                            id = parseInt(feature.properties.GEOID, 10);
                        } else if (feature.properties.cd_id) {
                            id = feature.properties.cd_id;
                        }
                    }
                    const rowData = dataMap[id];
                    const value = rowData ? rowData[metricKey] : null;
                    return {
                        ...feature,
                        properties: {
                            ...feature.properties,
                            value: value,
                            dataId: id
                        }
                    };
                })
            };
        }

        function initMap() {
            if (appState.map) {
                appState.map.remove();
            }
            appState.map = new maplibregl.Map({
                container: 'map-container',
                style: {
                    version: 8,
                    sources: {},
                    layers: [{
                        id: 'background',
                        type: 'background',
                        paint: { 'background-color': '#faf9f7' }
                    }]
                },
                center: [-98, 39],
                zoom: 3.5,
                minZoom: 2,
                maxZoom: 10,
                pixelRatio: window.devicePixelRatio || 1,
                antialias: true
            });
            appState.popup = new maplibregl.Popup({
                closeButton: false,
                closeOnClick: false
            });
            appState.map.on('load', () => {
                renderMapLayer();
                setupMapEventHandlers();
            });
        }

        function setupMapEventHandlers() {
            const map = appState.map;
            map.getCanvas().addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
                map.flyTo({ center: [-98, 39], zoom: 3.5, duration: 1000 });
            });
            let hoveredFeatureId = null;
            map.on('mousemove', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    map.getCanvas().style.cursor = 'pointer';
                    const feature = e.features[0];
                    const featureId = feature.id;
                    const value = feature.properties.value;
                    const dataId = feature.properties.dataId;
                    const metricInfo = METRICS[appState.metric];
                    if (hoveredFeatureId !== featureId) {
                        if (hoveredFeatureId !== null) {
                            map.setFeatureState({ source: 'regions', id: hoveredFeatureId }, { hover: false });
                        }
                        hoveredFeatureId = featureId;
                        map.setFeatureState({ source: 'regions', id: featureId }, { hover: true });
                    }
                    let name;
                    if (appState.viewType === 'state') {
                        name = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        const districtLabel = feature.properties.NAMELSAD || `District ${districtNum}`;
                        name = `${stateName}<br>${districtLabel}`;
                    }
                    const html = `
                        <div class="popup-title">${name}</div>
                        <div class="popup-value"><strong>${metricInfo.label}:</strong> ${formatValue(value, metricInfo.format)}</div>
                        <div class="popup-hint">Click to explore ‚Üí</div>
                    `;
                    appState.popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
                }
            });
            map.on('mouseleave', 'regions-fill', () => {
                map.getCanvas().style.cursor = '';
                appState.popup.remove();
                if (hoveredFeatureId !== null) {
                    map.setFeatureState({ source: 'regions', id: hoveredFeatureId }, { hover: false });
                    hoveredFeatureId = null;
                }
            });
            map.on('click', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const dataId = feature.properties.dataId;
                    let regionName;
                    if (appState.viewType === 'state') {
                        regionName = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        regionName = `${stateName} District ${districtNum}`;
                    }
                    appState.selectedRegion = { id: dataId, name: regionName };
                    document.getElementById('detail-container').innerHTML = renderDetailPanel();
                }
            });
        }

        function renderMapLayer() {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);
            const metricInfo = METRICS[appState.metric];
            const dataMap = {};
            if (appState.viewType === 'state') {
                filteredData.forEach(row => { dataMap[row.state] = row; });
            } else {
                filteredData.forEach(row => { dataMap[row.congressional_district_geoid] = row; });
            }
            const geoData = appState.viewType === 'state' ? appState.stateGeoData : appState.districtGeoData;
            const enrichedGeoData = enrichGeoDataWithValues(geoData, dataMap, null, appState.metric);
            const allValues = filteredData.map(d => d[appState.metric]).filter(v => !isNaN(v) && v !== null);
            const nonZeroValues = allValues.filter(v => Math.abs(v) > 0.0001);
            const min = nonZeroValues.length > 0 ? Math.min(...nonZeroValues) : 0;
            const max = nonZeroValues.length > 0 ? Math.max(...nonZeroValues) : 1;
            enrichedGeoData.features.forEach((feature, index) => {
                feature.id = index;
                const value = feature.properties.value;
                if (value === null || value === undefined || isNaN(value)) {
                    feature.properties.fillColor = NO_DATA_COLOR;
                } else if (Math.abs(value) < 0.0001) {
                    feature.properties.fillColor = ZERO_COLOR;
                } else {
                    let ratio = max > min ? (value - min) / (max - min) : 0;
                    ratio = Math.sqrt(ratio);
                    const idx = Math.min(Math.floor(ratio * (COLOR_SCALE.length - 1)), COLOR_SCALE.length - 1);
                    feature.properties.fillColor = COLOR_SCALE[idx];
                }
            });
            if (appState.map.getLayer('regions-fill')) appState.map.removeLayer('regions-fill');
            if (appState.map.getLayer('regions-line')) appState.map.removeLayer('regions-line');
            if (appState.map.getLayer('regions-hover-line')) appState.map.removeLayer('regions-hover-line');
            if (appState.map.getSource('regions')) appState.map.removeSource('regions');
            appState.map.addSource('regions', {
                type: 'geojson',
                data: enrichedGeoData,
                tolerance: 0.1
            });
            appState.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'regions',
                paint: {
                    'fill-color': ['get', 'fillColor'],
                    'fill-opacity': 1.0,
                    'fill-antialias': false
                }
            });
            appState.map.addLayer({
                id: 'regions-line',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': ['interpolate', ['linear'], ['zoom'], 3, 0.5, 5, 1, 8, 2]
                }
            });
            appState.map.addLayer({
                id: 'regions-hover-line',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#1e3a5f',
                    'line-width': 3,
                    'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]
                }
            });
            updateLegend(min, max, metricInfo);
        }

        function renderUI() {
            const metricInfo = METRICS[appState.metric];
            const viewLabel = appState.viewType === 'state' ? 'States' : 'Congressional Districts';
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);
            const totalCost = filteredData.reduce((sum, d) => sum + (d.cost || 0), 0);
            const avgPoverty = filteredData.reduce((sum, d) => sum + (d.poverty_pct_cut || 0), 0) / filteredData.length;
            const avgChildPoverty = filteredData.reduce((sum, d) => sum + (d.child_poverty_pct_cut || 0), 0) / filteredData.length;

            const html = `
                <div class="stats-banner">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-eyebrow">Total Investment</div>
                            <div class="stat-number">${formatValue(totalCost, 'currency')}</div>
                            <div class="stat-context">across all ${viewLabel.toLowerCase()}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-eyebrow">Poverty Reduction</div>
                            <div class="stat-number">${formatValue(avgPoverty, 'percent')}</div>
                            <div class="stat-context">average decrease</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-eyebrow">Child Poverty Reduction</div>
                            <div class="stat-number">${formatValue(avgChildPoverty, 'percent')}</div>
                            <div class="stat-context">average decrease</div>
                        </div>
                    </div>
                </div>

                <main class="main-content">
                    <div class="control-bar">
                        <div class="control-section">
                            <div class="control-group">
                                <span class="control-label">View</span>
                                <div class="pill-group">
                                    <button class="pill-btn ${appState.viewType === 'state' ? 'active' : ''}" onclick="setViewType('state')">States</button>
                                    <button class="pill-btn ${appState.viewType === 'district' ? 'active' : ''}" onclick="setViewType('district')">Districts</button>
                                </div>
                            </div>
                            <div class="control-group">
                                <span class="control-label">Credit Type</span>
                                <div class="pill-group">
                                    <button class="pill-btn ${appState.creditType === 'CTCs' ? 'active' : ''}" onclick="setCreditType('CTCs')">CTC</button>
                                    <button class="pill-btn ${appState.creditType === 'EITCs' ? 'active' : ''}" onclick="setCreditType('EITCs')">EITC</button>
                                    <button class="pill-btn ${appState.creditType === 'CTCs and EITCs' ? 'active' : ''}" onclick="setCreditType('CTCs and EITCs')">Both</button>
                                </div>
                            </div>
                        </div>
                        <div class="control-group">
                            <span class="control-label">Metric</span>
                            <select class="metric-dropdown" onchange="setMetric(this.value)">
                                ${Object.entries(METRICS).map(([key, val]) =>
                                    `<option value="${key}" ${key === appState.metric ? 'selected' : ''}>${val.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="visualization">
                        <div class="map-container">
                            <div class="map-header">
                                <span class="map-title">${metricInfo.label} by ${viewLabel}</span>
                                <span class="map-hint">Double-click to reset view</span>
                            </div>
                            <div id="map-container"></div>
                            <div class="map-legend">
                                <div class="legend-title" id="legend-title">${metricInfo.label}</div>
                                <div class="legend-scale">
                                    <div class="legend-gradient"></div>
                                    <div class="legend-labels">
                                        <span id="legend-max">--</span>
                                        <span id="legend-min">--</span>
                                    </div>
                                </div>
                                <div class="legend-zero">
                                    <div class="legend-zero-swatch"></div>
                                    <span class="legend-zero-text">No program</span>
                                </div>
                            </div>
                        </div>
                        <div id="detail-container">
                            ${renderDetailPanel()}
                        </div>
                    </div>
                </main>
            `;
            document.getElementById('root').innerHTML = html;
            initMap();
        }

        function setViewType(type) {
            appState.viewType = type;
            appState.selectedRegion = null;
            renderUI();
        }

        function setCreditType(type) {
            appState.creditType = type;
            renderUI();
        }

        function setMetric(metric) {
            appState.metric = metric;
            if (appState.map && appState.map.loaded()) {
                renderMapLayer();
                document.getElementById('detail-container').innerHTML = renderDetailPanel();
            }
        }

        async function loadData() {
            try {
                const [stateResponse, districtResponse, stateGeoResponse, districtGeoResponse] = await Promise.all([
                    fetch('./data/state_impacts.csv'),
                    fetch('./data/district_impacts.csv'),
                    fetch('./data/states_from_districts.geojson'),
                    fetch('./data/real_congressional_districts.geojson')
                ]);
                const stateText = await stateResponse.text();
                const districtText = await districtResponse.text();
                const stateGeoJson = await stateGeoResponse.json();
                const districtGeoJson = await districtGeoResponse.json();
                appState.stateData = parseCSV(stateText);
                appState.districtData = parseCSV(districtText);

                function transformAlaska(coords, scale, targetLng, targetLat) {
                    const centerLng = -154, centerLat = 64;
                    if (typeof coords[0] === 'number') {
                        return [targetLng + (coords[0] - centerLng) * scale, targetLat + (coords[1] - centerLat) * scale];
                    }
                    return coords.map(c => transformAlaska(c, scale, targetLng, targetLat));
                }

                function transformHawaii(coords, targetLng, targetLat) {
                    const centerLng = -155.5, centerLat = 20;
                    if (typeof coords[0] === 'number') {
                        return [targetLng + coords[0] - centerLng, targetLat + coords[1] - centerLat];
                    }
                    return coords.map(c => transformHawaii(c, targetLng, targetLat));
                }

                const filteredFeatures = stateGeoJson.features
                    .filter(f => f.properties.name !== 'Puerto Rico')
                    .map(f => {
                        if (f.properties.name === 'Alaska') {
                            return { ...f, geometry: { ...f.geometry, coordinates: transformAlaska(f.geometry.coordinates, 0.35, -125, 27) }};
                        } else if (f.properties.name === 'Hawaii') {
                            return { ...f, geometry: { ...f.geometry, coordinates: transformHawaii(f.geometry.coordinates, -108, 27) }};
                        }
                        return f;
                    });

                appState.stateGeoData = { type: 'FeatureCollection', features: filteredFeatures };

                const transformedDistrictFeatures = districtGeoJson.features.map(f => {
                    const stateCode = f.properties.STATEFP || (f.properties.GEOID ? f.properties.GEOID.substring(0, 2) : null);
                    if (stateCode === '02') {
                        return { ...f, geometry: { ...f.geometry, coordinates: transformAlaska(f.geometry.coordinates, 0.35, -125, 27) }};
                    } else if (stateCode === '15') {
                        return { ...f, geometry: { ...f.geometry, coordinates: transformHawaii(f.geometry.coordinates, -108, 27) }};
                    }
                    return f;
                });

                appState.districtGeoData = { type: 'FeatureCollection', features: transformedDistrictFeatures };
                appState.usOutlineData = appState.stateGeoData;

                console.log(`Loaded ${appState.stateData.length} state rows, ${appState.districtData.length} district rows`);
                renderUI();
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('root').innerHTML = `
                    <div class="main-content">
                        <div class="loading">
                            <p style="color: #dc2626; font-weight: 600;">Error loading data: ${err.message}</p>
                            <p style="margin-top: 16px;">Run <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">python scripts/generate_data.py</code> to generate data files.</p>
                        </div>
                    </div>
                `;
            }
        }

        loadData();
    </script>
</body>
</html>
