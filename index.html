<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Tax Credits Impact | PolicyEngine</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        :root {
            --primary-teal: #319795;
            --primary-teal-light: #E6FFFA;
            --primary-teal-600: #2C7A7B;
            --primary-teal-900: #1D4044;
            --gray-50: #F9FAFB;
            --gray-100: #F2F4F7;
            --gray-200: #E5E7EB;
            --gray-700: #344054;
            --gray-900: #101828;
            --background-secondary: #F5F9FF;
            --text-primary: #000000;
            --text-secondary: #5A5A5A;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: var(--background-secondary);
        }

        .header {
            background-color: var(--primary-teal);
            color: var(--white);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        h1 {
            color: var(--gray-900);
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.5;
        }

        /* Controls Section */
        .controls {
            background-color: var(--white);
            padding: 24px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Toggle Button Group */
        .toggle-group {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background-color: var(--white);
            color: var(--gray-700);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-right: 1px solid var(--gray-200);
        }

        .toggle-btn:last-child {
            border-right: none;
        }

        .toggle-btn:hover {
            background-color: var(--gray-50);
        }

        .toggle-btn.active {
            background-color: var(--primary-teal);
            color: var(--white);
        }

        /* Dropdown Select */
        .metric-select {
            padding: 10px 16px;
            font-size: 14px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background-color: var(--white);
            color: var(--gray-700);
            cursor: pointer;
            min-width: 220px;
        }

        .metric-select:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 0 3px rgba(49, 151, 149, 0.1);
        }

        /* Statistics Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-teal);
            color: var(--white);
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(49, 151, 149, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(49, 151, 149, 0.25);
            background: var(--primary-teal-600);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        /* Map and Detail Panel Layout */
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }

        /* Map Container */
        .map-wrapper {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .map-title {
            color: var(--gray-900);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #map-container {
            width: 100%;
            height: 700px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Custom Legend */
        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
            z-index: 1;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-900);
        }

        .legend-scale {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 2px;
        }

        .legend-gradient {
            width: 20px;
            height: 120px;
            border-radius: 2px;
            background: linear-gradient(to bottom, #1D4044, #2C7A7B, #38B2AC, #81E6D9, #B2F5EA, #E6FFFA);
        }

        .legend-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Detail Panel */
        .detail-panel {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
        }

        .detail-header {
            border-bottom: 2px solid var(--primary-teal);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .detail-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .detail-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .detail-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .detail-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .detail-metrics {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .detail-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .detail-metric:last-child {
            border-bottom: none;
        }

        .detail-metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .detail-metric-value.positive {
            color: #059669;
        }

        .detail-metric-value.negative {
            color: #DC2626;
        }

        .loading {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
            font-size: 18px;
        }

        .loading-spinner {
            border: 4px solid var(--gray-100);
            border-top: 4px solid var(--primary-teal);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .footer a {
            color: var(--primary-teal);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* MapLibre Popup Styling */
        .maplibregl-popup-content {
            padding: 12px 16px;
            border-radius: 8px;
            font-family: inherit;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .maplibregl-popup-close-button {
            font-size: 18px;
            padding: 4px 8px;
        }

        .popup-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .popup-value {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-hint {
            font-size: 11px;
            color: var(--primary-teal);
            margin-top: 6px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .toggle-group {
                flex-wrap: wrap;
            }

            .toggle-btn {
                flex: 1;
                min-width: 80px;
            }

            h1 {
                font-size: 24px;
            }

            .stat-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="https://policyengine.org" class="header-logo">
            <img src="policyengine-logo.svg" alt="PolicyEngine" style="height: 40px; vertical-align: middle;" />
        </a>
    </div>

    <div id="root">
        <div class="container">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading data...
            </div>
        </div>
    </div>

    <div class="footer">
        Data source: PolicyEngine microsimulation model (2025) |
        <a href="https://policyengine.org" target="_blank">policyengine.org</a>
    </div>

    <script>
        // Using MapLibre GL JS (free, no token required)

        // State codes and names
        const STATE_CODES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
            'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
            'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
            'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
            'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
            'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
            'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
            'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
            'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
            'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        const STATE_FIPS_NAMES = {
            1: 'Alabama', 2: 'Alaska', 4: 'Arizona', 5: 'Arkansas', 6: 'California',
            8: 'Colorado', 9: 'Connecticut', 10: 'Delaware', 11: 'District of Columbia',
            12: 'Florida', 13: 'Georgia', 15: 'Hawaii', 16: 'Idaho', 17: 'Illinois',
            18: 'Indiana', 19: 'Iowa', 20: 'Kansas', 21: 'Kentucky', 22: 'Louisiana',
            23: 'Maine', 24: 'Maryland', 25: 'Massachusetts', 26: 'Michigan', 27: 'Minnesota',
            28: 'Mississippi', 29: 'Missouri', 30: 'Montana', 31: 'Nebraska', 32: 'Nevada',
            33: 'New Hampshire', 34: 'New Jersey', 35: 'New Mexico', 36: 'New York',
            37: 'North Carolina', 38: 'North Dakota', 39: 'Ohio', 40: 'Oklahoma',
            41: 'Oregon', 42: 'Pennsylvania', 44: 'Rhode Island', 45: 'South Carolina',
            46: 'South Dakota', 47: 'Tennessee', 48: 'Texas', 49: 'Utah', 50: 'Vermont',
            51: 'Virginia', 53: 'Washington', 54: 'West Virginia', 55: 'Wisconsin', 56: 'Wyoming'
        };

        const STATE_FIPS_TO_CODE = {
            1: 'AL', 2: 'AK', 4: 'AZ', 5: 'AR', 6: 'CA', 8: 'CO', 9: 'CT', 10: 'DE',
            11: 'DC', 12: 'FL', 13: 'GA', 15: 'HI', 16: 'ID', 17: 'IL', 18: 'IN', 19: 'IA',
            20: 'KS', 21: 'KY', 22: 'LA', 23: 'ME', 24: 'MD', 25: 'MA', 26: 'MI', 27: 'MN',
            28: 'MS', 29: 'MO', 30: 'MT', 31: 'NE', 32: 'NV', 33: 'NH', 34: 'NJ', 35: 'NM',
            36: 'NY', 37: 'NC', 38: 'ND', 39: 'OH', 40: 'OK', 41: 'OR', 42: 'PA', 44: 'RI',
            45: 'SC', 46: 'SD', 47: 'TN', 48: 'TX', 49: 'UT', 50: 'VT', 51: 'VA', 53: 'WA',
            54: 'WV', 55: 'WI', 56: 'WY'
        };

        // Reverse lookup: state name to state code
        const STATE_NAME_TO_CODE = {};
        Object.entries(STATE_CODES).forEach(([code, name]) => {
            STATE_NAME_TO_CODE[name] = code;
        });

        const METRICS = {
            'cost': { label: 'Total Cost', format: 'currency', colorscaleReverse: false },
            'poverty_pct_cut': { label: 'Poverty Reduction', format: 'percent', colorscaleReverse: false },
            'child_poverty_pct_cut': { label: 'Child Poverty Reduction', format: 'percent', colorscaleReverse: false },
            'poverty_gap_pct_cut': { label: 'Poverty Gap Reduction', format: 'percent', colorscaleReverse: false },
            'gini_index_pct_cut': { label: 'Inequality Reduction (Gini)', format: 'percent', colorscaleReverse: false }
        };

        // Teal color scale
        const COLOR_SCALE = [
            '#E6FFFA',  // lightest
            '#B2F5EA',
            '#81E6D9',
            '#38B2AC',
            '#2C7A7B',
            '#1D4044'   // darkest
        ];

        // App state
        let appState = {
            viewType: 'state',
            creditType: 'CTCs and EITCs',
            metric: 'cost',
            stateData: null,
            districtData: null,
            stateGeoData: null,
            districtGeoData: null,
            selectedRegion: null,
            map: null,
            popup: null
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, idx) => {
                    const val = values[idx];
                    row[header] = isNaN(val) ? val : parseFloat(val);
                });
                data.push(row);
            }
            return data;
        }

        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';

            if (format === 'currency') {
                const absValue = Math.abs(value);
                if (absValue >= 1e9) {
                    return '$' + (value / 1e9).toFixed(2) + 'B';
                } else if (absValue >= 1e6) {
                    return '$' + (value / 1e6).toFixed(1) + 'M';
                } else if (absValue >= 1e3) {
                    return '$' + (value / 1e3).toFixed(1) + 'K';
                }
                return '$' + value.toFixed(0);
            } else if (format === 'percent') {
                return (value * 100).toFixed(2) + '%';
            }
            return value.toFixed(2);
        }

        function filterData(data, creditType) {
            return data.filter(row => row.reform_type === creditType);
        }

        function calculateStats(data, metric) {
            const values = data.map(d => d[metric]).filter(v => !isNaN(v) && v !== null);
            const total = values.reduce((a, b) => a + b, 0);
            const avg = total / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            return { total, avg, max, min, count: values.length };
        }

        function getColorForValue(value, min, max) {
            if (value === null || value === undefined || isNaN(value)) {
                return '#E5E7EB'; // gray for no data
            }
            const ratio = max > min ? (value - min) / (max - min) : 0;
            const index = Math.min(Math.floor(ratio * (COLOR_SCALE.length - 1)), COLOR_SCALE.length - 1);
            return COLOR_SCALE[index];
        }

        function getRegionData(regionId) {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);

            if (appState.viewType === 'state') {
                return filteredData.find(d => d.state === regionId);
            } else {
                return filteredData.find(d => d.congressional_district_geoid === regionId);
            }
        }

        function renderDetailPanel() {
            const region = appState.selectedRegion;

            if (!region) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <div class="detail-empty-icon">&#128205;</div>
                            <p>Click on a ${appState.viewType === 'state' ? 'state' : 'district'} to see detailed impact metrics</p>
                        </div>
                    </div>
                `;
            }

            const data = getRegionData(region.id);
            if (!data) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <p>No data available for this region</p>
                        </div>
                    </div>
                `;
            }

            const metrics = [
                { key: 'cost', label: 'Total Cost', format: 'currency' },
                { key: 'poverty_pct_cut', label: 'Poverty Reduction', format: 'percent' },
                { key: 'child_poverty_pct_cut', label: 'Child Poverty Reduction', format: 'percent' },
                { key: 'poverty_gap_pct_cut', label: 'Poverty Gap Reduction', format: 'percent' },
                { key: 'gini_index_pct_cut', label: 'Inequality Reduction', format: 'percent' }
            ];

            return `
                <div class="detail-panel">
                    <div class="detail-header">
                        <div class="detail-title">${region.name}</div>
                        <div class="detail-subtitle">${appState.creditType} Impact</div>
                    </div>
                    <div class="detail-metrics">
                        ${metrics.map(m => {
                            const value = data[m.key];
                            const formattedValue = formatValue(value, m.format);
                            const valueClass = m.format === 'percent' && value > 0 ? 'positive' : '';
                            return `
                                <div class="detail-metric">
                                    <span class="detail-metric-label">${m.label}</span>
                                    <span class="detail-metric-value ${valueClass}">${formattedValue}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function updateStats(stats, metricInfo) {
            const statElements = {
                'stat-total': metricInfo.format === 'currency' ? formatValue(stats.total, 'currency') : formatValue(stats.avg, metricInfo.format),
                'stat-count': stats.count,
                'stat-max': formatValue(stats.max, metricInfo.format),
                'stat-min': formatValue(stats.min, metricInfo.format)
            };

            const totalLabel = metricInfo.format === 'currency' ? 'Total Cost' : 'Average ' + metricInfo.label;
            document.getElementById('stat-total-label').textContent = totalLabel;

            Object.entries(statElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
        }

        function updateLegend(min, max, metricInfo) {
            document.getElementById('legend-max').textContent = formatValue(max, metricInfo.format);
            document.getElementById('legend-min').textContent = formatValue(min, metricInfo.format);
            document.getElementById('legend-title').textContent = metricInfo.label;
        }

        function enrichGeoDataWithValues(geoData, dataMap, idField, metricKey) {
            // Create a new GeoJSON with values added
            return {
                type: 'FeatureCollection',
                features: geoData.features.map(feature => {
                    let id;
                    if (appState.viewType === 'state') {
                        // State GeoJSON uses 'name' property (full state name)
                        const stateName = feature.properties.name;
                        id = STATE_NAME_TO_CODE[stateName];
                    } else {
                        if (feature.properties.GEOID) {
                            id = parseInt(feature.properties.GEOID, 10);
                        } else if (feature.properties.cd_id) {
                            id = feature.properties.cd_id;
                        }
                    }

                    const rowData = dataMap[id];
                    const value = rowData ? rowData[metricKey] : null;

                    return {
                        ...feature,
                        properties: {
                            ...feature.properties,
                            value: value,
                            dataId: id
                        }
                    };
                })
            };
        }

        function initMap() {
            if (appState.map) {
                appState.map.remove();
            }

            appState.map = new maplibregl.Map({
                container: 'map-container',
                style: {
                    version: 8,
                    sources: {},
                    layers: [{
                        id: 'background',
                        type: 'background',
                        paint: { 'background-color': '#ffffff' }
                    }]
                },
                center: [-98, 39],
                zoom: 3.5,
                minZoom: 2,
                maxZoom: 10
            });

            appState.popup = new maplibregl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            appState.map.on('load', () => {
                renderMapLayer();
                setupMapEventHandlers();
            });
        }

        function setupMapEventHandlers() {
            const map = appState.map;

            // Double-click to reset view to full US
            map.getCanvas().addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
                map.flyTo({
                    center: [-98, 39],
                    zoom: 3.5,
                    duration: 1000  // 1 second animation
                });
            });

            // Hover effects
            map.on('mousemove', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    map.getCanvas().style.cursor = 'pointer';

                    const feature = e.features[0];
                    const value = feature.properties.value;
                    const dataId = feature.properties.dataId;
                    const metricInfo = METRICS[appState.metric];

                    let name;
                    if (appState.viewType === 'state') {
                        name = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        const districtLabel = feature.properties.NAMELSAD || `District ${districtNum}`;
                        name = `${stateName}<br>${districtLabel}`;
                    }

                    const html = `
                        <div class="popup-title">${name}</div>
                        <div class="popup-value"><b>${metricInfo.label}:</b> ${formatValue(value, metricInfo.format)}</div>
                        <div class="popup-hint">Click for details</div>
                    `;

                    appState.popup.setLngLat(e.lngLat).setHTML(html).addTo(map);

                    // Highlight
                    map.setFilter('regions-highlight', ['==', ['get', 'dataId'], dataId]);
                }
            });

            map.on('mouseleave', 'regions-fill', () => {
                map.getCanvas().style.cursor = '';
                appState.popup.remove();
                map.setFilter('regions-highlight', ['==', ['get', 'dataId'], '']);
            });

            // Click handler
            map.on('click', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const dataId = feature.properties.dataId;

                    let regionName;
                    if (appState.viewType === 'state') {
                        regionName = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        regionName = `${stateName} District ${districtNum}`;
                    }

                    appState.selectedRegion = { id: dataId, name: regionName };
                    document.getElementById('detail-container').innerHTML = renderDetailPanel();

                    // Keep highlight on selected
                    map.setFilter('regions-highlight', ['==', ['get', 'dataId'], dataId]);
                }
            });
        }

        function renderMapLayer() {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);

            const metricInfo = METRICS[appState.metric];
            const stats = calculateStats(filteredData, appState.metric);

            // Create data lookup map
            const dataMap = {};
            if (appState.viewType === 'state') {
                filteredData.forEach(row => {
                    dataMap[row.state] = row;
                });
            } else {
                filteredData.forEach(row => {
                    dataMap[row.congressional_district_geoid] = row;
                });
            }

            // Get the appropriate GeoJSON
            const geoData = appState.viewType === 'state' ? appState.stateGeoData : appState.districtGeoData;

            // Enrich GeoJSON with values
            const enrichedGeoData = enrichGeoDataWithValues(geoData, dataMap, null, appState.metric);

            // Generate color stops based on data
            const values = filteredData.map(d => d[appState.metric]).filter(v => !isNaN(v) && v !== null);
            const min = Math.min(...values);
            const max = Math.max(...values);

            // Pre-compute colors for each feature
            enrichedGeoData.features.forEach(feature => {
                const value = feature.properties.value;
                if (value === null || value === undefined || isNaN(value)) {
                    feature.properties.fillColor = '#E5E7EB';
                } else {
                    const ratio = max > min ? (value - min) / (max - min) : 0;
                    const index = Math.min(Math.floor(ratio * (COLOR_SCALE.length - 1)), COLOR_SCALE.length - 1);
                    feature.properties.fillColor = COLOR_SCALE[index];
                }
            });

            // Remove existing layers and sources
            if (appState.map.getLayer('regions-fill')) appState.map.removeLayer('regions-fill');
            if (appState.map.getLayer('regions-line')) appState.map.removeLayer('regions-line');
            if (appState.map.getLayer('regions-highlight')) appState.map.removeLayer('regions-highlight');
            if (appState.map.getLayer('us-outline')) appState.map.removeLayer('us-outline');
            if (appState.map.getSource('regions')) appState.map.removeSource('regions');
            if (appState.map.getSource('us-boundary')) appState.map.removeSource('us-boundary');

            // Add US outline source (using state boundaries)
            appState.map.addSource('us-boundary', {
                type: 'geojson',
                data: appState.usOutlineData,
                tolerance: 0.5
            });

            // Add source with tolerance for smoother rendering at low zoom
            appState.map.addSource('regions', {
                type: 'geojson',
                data: enrichedGeoData,
                tolerance: 0.5  // Simplify geometry for better zoomed-out appearance
            });

            // Add fill layer with pre-computed colors
            appState.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'regions',
                paint: {
                    'fill-color': ['get', 'fillColor'],
                    'fill-opacity': 0.9
                }
            });

            // Add border layer with zoom-dependent width (white internal borders)
            appState.map.addLayer({
                id: 'regions-line',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        3, 0.5,   // At zoom 3, line width 0.5
                        5, 1,     // At zoom 5, line width 1
                        8, 2      // At zoom 8+, line width 2
                    ]
                }
            });

            // Add US outline layer on top (subtle border around all states)
            appState.map.addLayer({
                id: 'us-outline',
                type: 'line',
                source: 'us-boundary',
                paint: {
                    'line-color': '#9CA3AF',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        3, 0.5,
                        5, 0.75,
                        8, 1
                    ],
                    'line-opacity': 0.5
                }
            });

            // Add highlight layer (initially invisible)
            appState.map.addLayer({
                id: 'regions-highlight',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#1D4044',
                    'line-width': 3
                },
                filter: ['==', ['get', 'dataId'], '']
            });

            updateStats(stats, metricInfo);
            updateLegend(min, max, metricInfo);
        }

        function renderUI() {
            const metricInfo = METRICS[appState.metric];
            const viewLabel = appState.viewType === 'state' ? 'States' : 'Congressional Districts';

            const html = `
                <div class="container">
                    <div class="page-header">
                        <h1>State Tax Credits Impact Map</h1>
                        <div class="subtitle">
                            Interactive visualization showing the impact of state-level Earned Income Tax Credits (EITCs)
                            and Child Tax Credits (CTCs) on poverty, inequality, and household incomes across the United States.
                            Data calculated using the PolicyEngine microsimulation model for 2025.
                        </div>
                    </div>

                    <div class="controls">
                        <div class="control-group">
                            <div class="control-label">View</div>
                            <div class="toggle-group">
                                <button class="toggle-btn ${appState.viewType === 'state' ? 'active' : ''}"
                                        onclick="setViewType('state')">States</button>
                                <button class="toggle-btn ${appState.viewType === 'district' ? 'active' : ''}"
                                        onclick="setViewType('district')">Districts</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="control-label">Tax Credit</div>
                            <div class="toggle-group">
                                <button class="toggle-btn ${appState.creditType === 'CTCs' ? 'active' : ''}"
                                        onclick="setCreditType('CTCs')">CTC</button>
                                <button class="toggle-btn ${appState.creditType === 'EITCs' ? 'active' : ''}"
                                        onclick="setCreditType('EITCs')">EITC</button>
                                <button class="toggle-btn ${appState.creditType === 'CTCs and EITCs' ? 'active' : ''}"
                                        onclick="setCreditType('CTCs and EITCs')">Both</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="control-label">Metric</div>
                            <select class="metric-select" onchange="setMetric(this.value)">
                                ${Object.entries(METRICS).map(([key, val]) =>
                                    `<option value="${key}" ${key === appState.metric ? 'selected' : ''}>${val.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label" id="stat-total-label">Total Cost</div>
                            <div class="stat-value" id="stat-total">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">${viewLabel}</div>
                            <div class="stat-value" id="stat-count">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Maximum</div>
                            <div class="stat-value" id="stat-max">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Minimum</div>
                            <div class="stat-value" id="stat-min">--</div>
                        </div>
                    </div>

                    <div class="content-wrapper">
                        <div class="map-wrapper" style="position: relative;">
                            <div class="map-title">${appState.creditType} Impact: ${metricInfo.label} by ${viewLabel}</div>
                            <div id="map-container"></div>
                            <div class="map-legend">
                                <div class="legend-title" id="legend-title">${metricInfo.label}</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="legend-gradient"></div>
                                    <div class="legend-labels">
                                        <span id="legend-max">--</span>
                                        <span id="legend-min">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="detail-container">
                            ${renderDetailPanel()}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('root').innerHTML = html;
            initMap();
        }

        function setViewType(type) {
            appState.viewType = type;
            appState.selectedRegion = null;
            renderUI();
        }

        function setCreditType(type) {
            appState.creditType = type;
            if (appState.map && appState.map.loaded()) {
                renderMapLayer();
                document.getElementById('detail-container').innerHTML = renderDetailPanel();
            }
        }

        function setMetric(metric) {
            appState.metric = metric;
            if (appState.map && appState.map.loaded()) {
                renderMapLayer();
                document.getElementById('detail-container').innerHTML = renderDetailPanel();
            }
        }

        async function loadData() {
            try {
                const [stateResponse, districtResponse, stateGeoResponse, districtGeoResponse] = await Promise.all([
                    fetch('./data/state_impacts.csv'),
                    fetch('./data/district_impacts.csv'),
                    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json'),
                    fetch('./data/real_congressional_districts.geojson')
                ]);

                const stateText = await stateResponse.text();
                const districtText = await districtResponse.text();
                const stateGeoJson = await stateGeoResponse.json();
                const districtGeoJson = await districtGeoResponse.json();

                appState.stateData = parseCSV(stateText);
                appState.districtData = parseCSV(districtText);

                // Filter out Puerto Rico from state GeoJSON
                appState.stateGeoData = {
                    type: 'FeatureCollection',
                    features: stateGeoJson.features.filter(f => f.properties.name !== 'Puerto Rico')
                };
                appState.districtGeoData = districtGeoJson;

                // Create US outline from state boundaries (same filtered data)
                appState.usOutlineData = appState.stateGeoData;

                console.log(`Loaded ${appState.stateData.length} state rows, ${appState.districtData.length} district rows`);

                renderUI();
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('root').innerHTML = `
                    <div class="container">
                        <div class="loading">
                            <p>Error loading data: ${err.message}</p>
                            <p style="margin-top: 20px; font-size: 14px;">
                                Make sure you have generated the data files by running:<br>
                                <code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                    python scripts/generate_data.py
                                </code>
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        loadData();
    </script>
</body>
</html>
