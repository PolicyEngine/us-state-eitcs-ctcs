<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Tax Credits Impact | PolicyEngine</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-teal: #319795;
            --primary-teal-light: #E6FFFA;
            --primary-teal-600: #2C7A7B;
            --primary-teal-900: #1D4044;
            --gray-50: #F9FAFB;
            --gray-100: #F2F4F7;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-700: #344054;
            --gray-900: #101828;
            --background-secondary: #F8FAFC;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --white: #FFFFFF;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--background-secondary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-600) 100%);
            color: var(--white);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .page-header {
            background-color: var(--white);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            border: 1px solid var(--gray-100);
        }

        h1 {
            color: var(--gray-900);
            font-size: 28px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
            max-width: 800px;
        }

        /* Controls Section */
        .controls {
            background-color: var(--white);
            padding: 20px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
            border: 1px solid var(--gray-100);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Toggle Button Group */
        .toggle-group {
            display: flex;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--gray-200);
            background-color: var(--gray-50);
            padding: 3px;
            gap: 3px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        .toggle-btn:hover {
            background-color: var(--gray-100);
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background-color: var(--white);
            color: var(--primary-teal);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }

        /* Dropdown Select */
        .metric-select {
            padding: 8px 14px;
            font-size: 13px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            background-color: var(--white);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 500;
            min-width: 220px;
        }

        .metric-select:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 0 3px rgba(49, 151, 149, 0.15);
        }

        /* Statistics Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .stats {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-600) 100%);
            color: var(--white);
            padding: 20px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.85;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        /* Map and Detail Panel Layout */
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }

        /* Map Container */
        .map-wrapper {
            background-color: var(--white);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
        }

        .map-title {
            color: var(--gray-900);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background: var(--primary-teal);
            border-radius: 2px;
        }

        #map-container {
            width: 100%;
            height: 600px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--gray-100);
        }

        /* Custom Legend */
        .map-legend {
            position: absolute;
            bottom: 24px;
            right: 12px;
            background: var(--white);
            padding: 14px 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            font-size: 11px;
            z-index: 1;
            border: 1px solid var(--gray-100);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray-900);
            font-size: 12px;
        }

        .legend-scale {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 2px;
        }

        .legend-gradient {
            width: 20px;
            height: 100px;
            border-radius: 2px;
            background: linear-gradient(to bottom, #1D4044, #2C7A7B, #319795, #38B2AC, #4FD1C5, #B2F5EA);
        }

        .legend-zero {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-200);
        }

        .legend-zero-color {
            width: 20px;
            height: 14px;
            border-radius: 2px;
            background-color: #E5E7EB;
        }

        .legend-zero-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .legend-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Detail Panel */
        .detail-panel {
            background-color: var(--white);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            position: sticky;
            top: 80px;
        }

        .detail-header {
            border-bottom: none;
            padding-bottom: 16px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--primary-teal-light) 0%, #fff 100%);
            margin: -24px -24px 20px -24px;
            padding: 20px 24px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .detail-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .detail-subtitle {
            font-size: 13px;
            color: var(--primary-teal-600);
            font-weight: 500;
        }

        .detail-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .detail-empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .detail-empty p {
            font-size: 14px;
            line-height: 1.5;
        }

        .detail-metrics {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .detail-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .detail-metric:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .detail-metric:first-child {
            padding-top: 0;
        }

        .detail-metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .detail-metric-value.positive {
            color: #059669;
        }

        .detail-metric-value.negative {
            color: #DC2626;
        }

        .loading {
            text-align: center;
            padding: 100px 40px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .loading-spinner {
            border: 3px solid var(--gray-100);
            border-top: 3px solid var(--primary-teal);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--gray-100);
            background: var(--white);
            margin-top: 24px;
        }

        .footer a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* MapLibre Popup Styling */
        .maplibregl-popup-content {
            padding: 14px 18px;
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-100);
        }

        .maplibregl-popup-close-button {
            font-size: 16px;
            padding: 4px 8px;
            color: var(--text-secondary);
        }

        .maplibregl-popup-tip {
            border-top-color: var(--white) !important;
        }

        .popup-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .popup-value {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .popup-value b {
            color: var(--text-primary);
        }

        .popup-hint {
            font-size: 11px;
            color: var(--primary-teal);
            margin-top: 8px;
            font-weight: 500;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .toggle-group {
                flex-wrap: wrap;
            }

            .toggle-btn {
                flex: 1;
                min-width: 80px;
            }

            h1 {
                font-size: 22px;
            }

            .stat-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="https://policyengine.org" class="header-logo">
            <img src="policyengine-logo.svg" alt="PolicyEngine" style="height: 40px; vertical-align: middle;" />
        </a>
    </div>

    <div id="root">
        <div class="container">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading data...
            </div>
        </div>
    </div>

    <div class="footer">
        Data source: PolicyEngine microsimulation model (2025) |
        <a href="https://policyengine.org" target="_blank">policyengine.org</a>
    </div>

    <script>
        // Using MapLibre GL JS (free, no token required)

        // State codes and names
        const STATE_CODES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
            'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
            'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
            'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
            'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
            'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
            'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
            'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
            'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
            'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        const STATE_FIPS_NAMES = {
            1: 'Alabama', 2: 'Alaska', 4: 'Arizona', 5: 'Arkansas', 6: 'California',
            8: 'Colorado', 9: 'Connecticut', 10: 'Delaware', 11: 'District of Columbia',
            12: 'Florida', 13: 'Georgia', 15: 'Hawaii', 16: 'Idaho', 17: 'Illinois',
            18: 'Indiana', 19: 'Iowa', 20: 'Kansas', 21: 'Kentucky', 22: 'Louisiana',
            23: 'Maine', 24: 'Maryland', 25: 'Massachusetts', 26: 'Michigan', 27: 'Minnesota',
            28: 'Mississippi', 29: 'Missouri', 30: 'Montana', 31: 'Nebraska', 32: 'Nevada',
            33: 'New Hampshire', 34: 'New Jersey', 35: 'New Mexico', 36: 'New York',
            37: 'North Carolina', 38: 'North Dakota', 39: 'Ohio', 40: 'Oklahoma',
            41: 'Oregon', 42: 'Pennsylvania', 44: 'Rhode Island', 45: 'South Carolina',
            46: 'South Dakota', 47: 'Tennessee', 48: 'Texas', 49: 'Utah', 50: 'Vermont',
            51: 'Virginia', 53: 'Washington', 54: 'West Virginia', 55: 'Wisconsin', 56: 'Wyoming'
        };

        const STATE_FIPS_TO_CODE = {
            1: 'AL', 2: 'AK', 4: 'AZ', 5: 'AR', 6: 'CA', 8: 'CO', 9: 'CT', 10: 'DE',
            11: 'DC', 12: 'FL', 13: 'GA', 15: 'HI', 16: 'ID', 17: 'IL', 18: 'IN', 19: 'IA',
            20: 'KS', 21: 'KY', 22: 'LA', 23: 'ME', 24: 'MD', 25: 'MA', 26: 'MI', 27: 'MN',
            28: 'MS', 29: 'MO', 30: 'MT', 31: 'NE', 32: 'NV', 33: 'NH', 34: 'NJ', 35: 'NM',
            36: 'NY', 37: 'NC', 38: 'ND', 39: 'OH', 40: 'OK', 41: 'OR', 42: 'PA', 44: 'RI',
            45: 'SC', 46: 'SD', 47: 'TN', 48: 'TX', 49: 'UT', 50: 'VT', 51: 'VA', 53: 'WA',
            54: 'WV', 55: 'WI', 56: 'WY'
        };

        // Reverse lookup: state name to state code
        const STATE_NAME_TO_CODE = {};
        Object.entries(STATE_CODES).forEach(([code, name]) => {
            STATE_NAME_TO_CODE[name] = code;
        });

        const METRICS = {
            'cost': { label: 'Total Cost', format: 'currency', colorscaleReverse: false },
            'poverty_pct_cut': { label: 'Poverty Reduction', format: 'percent', colorscaleReverse: false },
            'child_poverty_pct_cut': { label: 'Child Poverty Reduction', format: 'percent', colorscaleReverse: false }
        };

        // Color for zero/no-impact states (clearly greyed out)
        const ZERO_COLOR = '#E5E7EB';  // Gray
        const NO_DATA_COLOR = '#F3F4F6';  // Lighter gray for no data

        // Teal color scale with better contrast - using fewer, more distinct colors
        const COLOR_SCALE = [
            '#B2F5EA',  // light teal (for low non-zero values)
            '#4FD1C5',  // medium-light teal
            '#38B2AC',  // medium teal
            '#319795',  // teal
            '#2C7A7B',  // dark teal
            '#1D4044'   // darkest teal (for highest values)
        ];

        // App state
        let appState = {
            viewType: 'state',
            creditType: 'CTCs and EITCs',
            metric: 'cost',
            stateData: null,
            districtData: null,
            stateGeoData: null,
            districtGeoData: null,
            selectedRegion: null,
            map: null,
            popup: null
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, idx) => {
                    const val = values[idx];
                    row[header] = isNaN(val) ? val : parseFloat(val);
                });
                data.push(row);
            }
            return data;
        }

        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';

            if (format === 'currency') {
                const absValue = Math.abs(value);
                if (absValue >= 1e9) {
                    return '$' + (value / 1e9).toFixed(2) + 'B';
                } else if (absValue >= 1e6) {
                    return '$' + (value / 1e6).toFixed(1) + 'M';
                } else if (absValue >= 1e3) {
                    return '$' + (value / 1e3).toFixed(1) + 'K';
                }
                return '$' + value.toFixed(0);
            } else if (format === 'percent') {
                return (value * 100).toFixed(2) + '%';
            }
            return value.toFixed(2);
        }

        function filterData(data, creditType) {
            return data.filter(row => row.reform_type === creditType);
        }

        function calculateStats(data, metric) {
            const values = data.map(d => d[metric]).filter(v => !isNaN(v) && v !== null);
            const total = values.reduce((a, b) => a + b, 0);
            const avg = total / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            return { total, avg, max, min, count: values.length };
        }

        function getColorForValue(value, min, max) {
            if (value === null || value === undefined || isNaN(value)) {
                return '#E5E7EB'; // gray for no data
            }
            const ratio = max > min ? (value - min) / (max - min) : 0;
            const index = Math.min(Math.floor(ratio * (COLOR_SCALE.length - 1)), COLOR_SCALE.length - 1);
            return COLOR_SCALE[index];
        }

        function getRegionData(regionId) {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);

            if (appState.viewType === 'state') {
                return filteredData.find(d => d.state === regionId);
            } else {
                return filteredData.find(d => d.congressional_district_geoid === regionId);
            }
        }

        function renderDetailPanel() {
            const region = appState.selectedRegion;

            if (!region) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <div class="detail-empty-icon">&#128205;</div>
                            <p>Click on a ${appState.viewType === 'state' ? 'state' : 'district'} to see detailed impact metrics</p>
                        </div>
                    </div>
                `;
            }

            const data = getRegionData(region.id);
            if (!data) {
                return `
                    <div class="detail-panel">
                        <div class="detail-empty">
                            <p>No data available for this region</p>
                        </div>
                    </div>
                `;
            }

            const metrics = [
                { key: 'cost', label: 'Total Cost', format: 'currency' },
                { key: 'poverty_pct_cut', label: 'Poverty Reduction', format: 'percent' },
                { key: 'child_poverty_pct_cut', label: 'Child Poverty Reduction', format: 'percent' }
            ];

            return `
                <div class="detail-panel">
                    <div class="detail-header">
                        <div class="detail-title">${region.name}</div>
                        <div class="detail-subtitle">${appState.creditType} Impact</div>
                    </div>
                    <div class="detail-metrics">
                        ${metrics.map(m => {
                            const value = data[m.key];
                            const formattedValue = formatValue(value, m.format);
                            const valueClass = m.format === 'percent' && value > 0 ? 'positive' : '';
                            return `
                                <div class="detail-metric">
                                    <span class="detail-metric-label">${m.label}</span>
                                    <span class="detail-metric-value ${valueClass}">${formattedValue}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function updateStats(stats, metricInfo) {
            // Stats are now rendered directly in renderUI, this function updates summary stats
            // when credit type or view changes without full re-render
        }

        function updateLegend(min, max, metricInfo) {
            document.getElementById('legend-max').textContent = formatValue(max, metricInfo.format);
            document.getElementById('legend-min').textContent = formatValue(min, metricInfo.format);
            document.getElementById('legend-title').textContent = metricInfo.label;
        }

        function enrichGeoDataWithValues(geoData, dataMap, idField, metricKey) {
            // Create a new GeoJSON with values added
            return {
                type: 'FeatureCollection',
                features: geoData.features.map(feature => {
                    let id;
                    if (appState.viewType === 'state') {
                        // State GeoJSON uses 'name' property (full state name)
                        const stateName = feature.properties.name;
                        id = STATE_NAME_TO_CODE[stateName];
                    } else {
                        if (feature.properties.GEOID) {
                            id = parseInt(feature.properties.GEOID, 10);
                        } else if (feature.properties.cd_id) {
                            id = feature.properties.cd_id;
                        }
                    }

                    const rowData = dataMap[id];
                    const value = rowData ? rowData[metricKey] : null;

                    return {
                        ...feature,
                        properties: {
                            ...feature.properties,
                            value: value,
                            dataId: id
                        }
                    };
                })
            };
        }

        function initMap() {
            if (appState.map) {
                appState.map.remove();
            }

            appState.map = new maplibregl.Map({
                container: 'map-container',
                style: {
                    version: 8,
                    sources: {},
                    layers: [{
                        id: 'background',
                        type: 'background',
                        paint: { 'background-color': '#ffffff' }
                    }]
                },
                center: [-98, 39],
                zoom: 3.5,
                minZoom: 2,
                maxZoom: 10,
                pixelRatio: window.devicePixelRatio || 1,  // Crisp rendering on high-DPI displays
                antialias: true  // Better overall rendering quality
            });

            appState.popup = new maplibregl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            appState.map.on('load', () => {
                renderMapLayer();
                setupMapEventHandlers();
            });
        }

        function setupMapEventHandlers() {
            const map = appState.map;

            // Double-click to reset view to full US
            map.getCanvas().addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
                map.flyTo({
                    center: [-98, 39],
                    zoom: 3.5,
                    duration: 1000  // 1 second animation
                });
            });

            // Track currently hovered feature for fast state updates
            let hoveredFeatureId = null;

            // Hover effects using feature-state (much faster than setFilter)
            map.on('mousemove', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    map.getCanvas().style.cursor = 'pointer';

                    const feature = e.features[0];
                    const featureId = feature.id;
                    const value = feature.properties.value;
                    const dataId = feature.properties.dataId;
                    const metricInfo = METRICS[appState.metric];

                    // Only update if we're on a new feature
                    if (hoveredFeatureId !== featureId) {
                        // Clear previous hover state
                        if (hoveredFeatureId !== null) {
                            map.setFeatureState(
                                { source: 'regions', id: hoveredFeatureId },
                                { hover: false }
                            );
                        }
                        // Set new hover state
                        hoveredFeatureId = featureId;
                        map.setFeatureState(
                            { source: 'regions', id: featureId },
                            { hover: true }
                        );
                    }

                    let name;
                    if (appState.viewType === 'state') {
                        name = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        const districtLabel = feature.properties.NAMELSAD || `District ${districtNum}`;
                        name = `${stateName}<br>${districtLabel}`;
                    }

                    const html = `
                        <div class="popup-title">${name}</div>
                        <div class="popup-value"><b>${metricInfo.label}:</b> ${formatValue(value, metricInfo.format)}</div>
                        <div class="popup-hint">Click for details</div>
                    `;

                    appState.popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
                }
            });

            map.on('mouseleave', 'regions-fill', () => {
                map.getCanvas().style.cursor = '';
                appState.popup.remove();
                if (hoveredFeatureId !== null) {
                    map.setFeatureState(
                        { source: 'regions', id: hoveredFeatureId },
                        { hover: false }
                    );
                    hoveredFeatureId = null;
                }
            });

            // Click handler
            map.on('click', 'regions-fill', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const dataId = feature.properties.dataId;

                    let regionName;
                    if (appState.viewType === 'state') {
                        regionName = STATE_CODES[dataId] || feature.properties.name || dataId;
                    } else {
                        const stateFips = Math.floor(dataId / 100);
                        const districtNum = dataId % 100;
                        const stateName = STATE_FIPS_NAMES[stateFips] || 'Unknown';
                        regionName = `${stateName} District ${districtNum}`;
                    }

                    appState.selectedRegion = { id: dataId, name: regionName };
                    document.getElementById('detail-container').innerHTML = renderDetailPanel();
                }
            });
        }

        function renderMapLayer() {
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);

            const metricInfo = METRICS[appState.metric];
            const stats = calculateStats(filteredData, appState.metric);

            // Create data lookup map
            const dataMap = {};
            if (appState.viewType === 'state') {
                filteredData.forEach(row => {
                    dataMap[row.state] = row;
                });
            } else {
                filteredData.forEach(row => {
                    dataMap[row.congressional_district_geoid] = row;
                });
            }

            // Get the appropriate GeoJSON
            const geoData = appState.viewType === 'state' ? appState.stateGeoData : appState.districtGeoData;

            // Enrich GeoJSON with values
            const enrichedGeoData = enrichGeoDataWithValues(geoData, dataMap, null, appState.metric);

            // Generate color stops based on data - only consider non-zero values for scaling
            const allValues = filteredData.map(d => d[appState.metric]).filter(v => !isNaN(v) && v !== null);
            const nonZeroValues = allValues.filter(v => Math.abs(v) > 0.0001);  // Filter out zeros

            // Use non-zero values for min/max to get better color distribution
            const min = nonZeroValues.length > 0 ? Math.min(...nonZeroValues) : 0;
            const max = nonZeroValues.length > 0 ? Math.max(...nonZeroValues) : 1;

            // Pre-compute colors for each feature and assign unique IDs
            enrichedGeoData.features.forEach((feature, index) => {
                // Assign unique ID for feature-state to work
                feature.id = index;

                const value = feature.properties.value;
                if (value === null || value === undefined || isNaN(value)) {
                    // No data - light gray
                    feature.properties.fillColor = NO_DATA_COLOR;
                    feature.properties.isZero = false;
                    feature.properties.hasData = false;
                } else if (Math.abs(value) < 0.0001) {
                    // Zero impact - clearly greyed out
                    feature.properties.fillColor = ZERO_COLOR;
                    feature.properties.isZero = true;
                    feature.properties.hasData = true;
                } else {
                    // Non-zero value - use color scale with better distribution
                    // Use logarithmic-like scaling for better contrast across wide ranges
                    let ratio = max > min ? (value - min) / (max - min) : 0;
                    // Apply sqrt to spread out lower values more
                    ratio = Math.sqrt(ratio);
                    const idx = Math.min(Math.floor(ratio * (COLOR_SCALE.length - 1)), COLOR_SCALE.length - 1);
                    feature.properties.fillColor = COLOR_SCALE[idx];
                    feature.properties.isZero = false;
                    feature.properties.hasData = true;
                }
            });

            // Remove existing layers and sources
            if (appState.map.getLayer('regions-fill')) appState.map.removeLayer('regions-fill');
            if (appState.map.getLayer('regions-line')) appState.map.removeLayer('regions-line');
            if (appState.map.getLayer('regions-hover-line')) appState.map.removeLayer('regions-hover-line');
            if (appState.map.getLayer('us-outline')) appState.map.removeLayer('us-outline');
            if (appState.map.getSource('regions')) appState.map.removeSource('regions');
            if (appState.map.getSource('us-boundary')) appState.map.removeSource('us-boundary');

            // Add US outline source (using state boundaries)
            appState.map.addSource('us-boundary', {
                type: 'geojson',
                data: appState.usOutlineData,
                tolerance: 0.1  // Lower tolerance for sharper outline
            });

            // Add source with low tolerance for sharper colors
            appState.map.addSource('regions', {
                type: 'geojson',
                data: enrichedGeoData,
                tolerance: 0.1  // Low tolerance preserves more detail for sharper appearance
            });

            // Add fill layer with pre-computed colors - full opacity and no antialias for sharper edges
            appState.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'regions',
                paint: {
                    'fill-color': ['get', 'fillColor'],
                    'fill-opacity': 1.0,
                    'fill-antialias': false  // Sharper edges at low zoom
                }
            });

            // Add border layer with zoom-dependent width (white internal borders)
            appState.map.addLayer({
                id: 'regions-line',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        3, 0.5,   // At zoom 3, line width 0.5
                        5, 1,     // At zoom 5, line width 1
                        8, 2      // At zoom 8+, line width 2
                    ]
                }
            });

            // Add hover highlight layer using feature-state (faster than filter)
            appState.map.addLayer({
                id: 'regions-hover-line',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': '#1D4044',
                    'line-width': 3,
                    'line-opacity': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        1,
                        0
                    ]
                }
            });

            // Add US outline layer on top (subtle border around all states)
            appState.map.addLayer({
                id: 'us-outline',
                type: 'line',
                source: 'us-boundary',
                paint: {
                    'line-color': '#9CA3AF',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        3, 0.5,
                        5, 0.75,
                        8, 1
                    ],
                    'line-opacity': 0.5
                }
            });

            updateStats(stats, metricInfo);
            updateLegend(min, max, metricInfo);
        }

        function renderUI() {
            const metricInfo = METRICS[appState.metric];
            const viewLabel = appState.viewType === 'state' ? 'States' : 'Congressional Districts';

            // Calculate summary stats for all metrics
            const filteredData = appState.viewType === 'state'
                ? filterData(appState.stateData, appState.creditType)
                : filterData(appState.districtData, appState.creditType);

            const totalCost = filteredData.reduce((sum, d) => sum + (d.cost || 0), 0);
            const avgPoverty = filteredData.reduce((sum, d) => sum + (d.poverty_pct_cut || 0), 0) / filteredData.length;
            const avgChildPoverty = filteredData.reduce((sum, d) => sum + (d.child_poverty_pct_cut || 0), 0) / filteredData.length;

            const html = `
                <div class="container">
                    <div class="page-header">
                        <h1>State Tax Credits Impact Map</h1>
                        <div class="subtitle">
                            Interactive visualization showing the impact of state-level Earned Income Tax Credits (EITCs)
                            and Child Tax Credits (CTCs) on poverty and household incomes across the United States.
                            Data calculated using the PolicyEngine microsimulation model for 2025.
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Cost</div>
                            <div class="stat-value">${formatValue(totalCost, 'currency')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Poverty Reduction</div>
                            <div class="stat-value">${formatValue(avgPoverty, 'percent')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Child Poverty Reduction</div>
                            <div class="stat-value">${formatValue(avgChildPoverty, 'percent')}</div>
                        </div>
                    </div>

                    <div class="controls">
                        <div class="control-group">
                            <div class="control-label">View</div>
                            <div class="toggle-group">
                                <button class="toggle-btn ${appState.viewType === 'state' ? 'active' : ''}"
                                        onclick="setViewType('state')">States</button>
                                <button class="toggle-btn ${appState.viewType === 'district' ? 'active' : ''}"
                                        onclick="setViewType('district')">Districts</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="control-label">Tax Credit</div>
                            <div class="toggle-group">
                                <button class="toggle-btn ${appState.creditType === 'CTCs' ? 'active' : ''}"
                                        onclick="setCreditType('CTCs')">CTC</button>
                                <button class="toggle-btn ${appState.creditType === 'EITCs' ? 'active' : ''}"
                                        onclick="setCreditType('EITCs')">EITC</button>
                                <button class="toggle-btn ${appState.creditType === 'CTCs and EITCs' ? 'active' : ''}"
                                        onclick="setCreditType('CTCs and EITCs')">Both</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="control-label">Metric</div>
                            <select class="metric-select" onchange="setMetric(this.value)">
                                ${Object.entries(METRICS).map(([key, val]) =>
                                    `<option value="${key}" ${key === appState.metric ? 'selected' : ''}>${val.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="content-wrapper">
                        <div class="map-wrapper" style="position: relative;">
                            <div class="map-title">${appState.creditType} Impact: ${metricInfo.label} by ${viewLabel}</div>
                            <div id="map-container"></div>
                            <div class="map-legend">
                                <div class="legend-title" id="legend-title">${metricInfo.label}</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="legend-gradient"></div>
                                    <div class="legend-labels">
                                        <span id="legend-max">--</span>
                                        <span id="legend-min">--</span>
                                    </div>
                                </div>
                                <div class="legend-zero">
                                    <div class="legend-zero-color"></div>
                                    <span class="legend-zero-label">No impact</span>
                                </div>
                            </div>
                        </div>
                        <div id="detail-container">
                            ${renderDetailPanel()}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('root').innerHTML = html;
            initMap();
        }

        function setViewType(type) {
            appState.viewType = type;
            appState.selectedRegion = null;
            renderUI();
        }

        function setCreditType(type) {
            appState.creditType = type;
            // Re-render entire UI since stats depend on credit type
            renderUI();
        }

        function setMetric(metric) {
            appState.metric = metric;
            if (appState.map && appState.map.loaded()) {
                renderMapLayer();
                document.getElementById('detail-container').innerHTML = renderDetailPanel();
            }
        }

        async function loadData() {
            try {
                const [stateResponse, districtResponse, stateGeoResponse, districtGeoResponse] = await Promise.all([
                    fetch('./data/state_impacts.csv'),
                    fetch('./data/district_impacts.csv'),
                    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json'),
                    fetch('./data/real_congressional_districts.geojson')
                ]);

                const stateText = await stateResponse.text();
                const districtText = await districtResponse.text();
                const stateGeoJson = await stateGeoResponse.json();
                const districtGeoJson = await districtGeoResponse.json();

                appState.stateData = parseCSV(stateText);
                appState.districtData = parseCSV(districtText);

                // Transform Alaska - scale uniformly and reposition
                function transformAlaska(coords, scale, targetLng, targetLat) {
                    // Alaska bounding box center approximately at [-154, 64]
                    const centerLng = -154;
                    const centerLat = 64;

                    if (typeof coords[0] === 'number') {
                        // Scale coordinates around Alaska's center, then move to target position
                        const scaledLng = (coords[0] - centerLng) * scale;
                        const scaledLat = (coords[1] - centerLat) * scale;
                        return [targetLng + scaledLng, targetLat + scaledLat];
                    } else {
                        return coords.map(c => transformAlaska(c, scale, targetLng, targetLat));
                    }
                }

                function transformHawaii(coords, targetLng, targetLat) {
                    // Hawaii center approximately at [-155.5, 20]
                    const centerLng = -155.5;
                    const centerLat = 20;

                    if (typeof coords[0] === 'number') {
                        const offsetLng = coords[0] - centerLng;
                        const offsetLat = coords[1] - centerLat;
                        return [targetLng + offsetLng, targetLat + offsetLat];
                    } else {
                        return coords.map(c => transformHawaii(c, targetLng, targetLat));
                    }
                }

                // Filter out Puerto Rico and transform Alaska/Hawaii
                const filteredFeatures = stateGeoJson.features
                    .filter(f => f.properties.name !== 'Puerto Rico')
                    .map(f => {
                        if (f.properties.name === 'Alaska') {
                            // Scale Alaska to 35% and position below western US
                            return {
                                ...f,
                                geometry: {
                                    ...f.geometry,
                                    coordinates: transformAlaska(f.geometry.coordinates, 0.35, -125, 27)
                                }
                            };
                        } else if (f.properties.name === 'Hawaii') {
                            // Position Hawaii to the right of Alaska, below California
                            return {
                                ...f,
                                geometry: {
                                    ...f.geometry,
                                    coordinates: transformHawaii(f.geometry.coordinates, -108, 27)
                                }
                            };
                        }
                        return f;
                    });

                appState.stateGeoData = {
                    type: 'FeatureCollection',
                    features: filteredFeatures
                };

                // Also transform Alaska/Hawaii in district GeoJSON
                const transformedDistrictFeatures = districtGeoJson.features.map(f => {
                    const stateCode = f.properties.STATEFP || (f.properties.GEOID ? f.properties.GEOID.substring(0, 2) : null);
                    if (stateCode === '02') {  // Alaska
                        return {
                            ...f,
                            geometry: {
                                ...f.geometry,
                                coordinates: transformAlaska(f.geometry.coordinates, 0.35, -125, 27)
                            }
                        };
                    } else if (stateCode === '15') {  // Hawaii
                        return {
                            ...f,
                            geometry: {
                                ...f.geometry,
                                coordinates: transformHawaii(f.geometry.coordinates, -108, 27)
                            }
                        };
                    }
                    return f;
                });

                appState.districtGeoData = {
                    type: 'FeatureCollection',
                    features: transformedDistrictFeatures
                };

                // Create US outline from state boundaries (same filtered data)
                appState.usOutlineData = appState.stateGeoData;

                console.log(`Loaded ${appState.stateData.length} state rows, ${appState.districtData.length} district rows`);

                renderUI();
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('root').innerHTML = `
                    <div class="container">
                        <div class="loading">
                            <p>Error loading data: ${err.message}</p>
                            <p style="margin-top: 20px; font-size: 14px;">
                                Make sure you have generated the data files by running:<br>
                                <code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                    python scripts/generate_data.py
                                </code>
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        loadData();
    </script>
</body>
</html>
